# Solana Trading Bot - План внедрения API

## Этап 1: Предварительная настройка

- [ ] Создать ветку для разработки API
  ```bash
  git checkout -b feature/api-implementation
  ```

- [ ] Создать необходимые директории
  ```bash
  mkdir -p internal/botapi
  mkdir -p internal/tui
  mkdir -p internal/errs
  mkdir -p internal/core
  ```

- [ ] Проверить существующие методы в Runner и TaskManager
  - [ ] Изучить `internal/bot/runner.go` для доступных методов
  - [ ] Изучить `internal/task/manager.go` для доступных методов
  - [ ] Составить список методов, которые нужно будет экспортировать через API

## Этап 2: Реализация модуля ошибок

- [ ] Создать файл `internal/errs/errors.go`
  - [ ] Определить константы для типов ошибок
  - [ ] Создать структуру BotError
  - [ ] Реализовать метод Error()
  - [ ] Реализовать функцию New()
  - [ ] Реализовать функцию Wrap()

- [ ] Создать файл `internal/errs/errors_test.go`
  - [ ] Тест для создания новой ошибки
  - [ ] Тест для оборачивания существующей ошибки
  - [ ] Тест для проверки форматирования сообщения ошибки

## Этап 3: Реализация API с миксинами

### 3.1. Основная структура API

- [ ] Создать файл `internal/botapi/api.go`
  - [ ] Определить структуру BotAPI с Runner и TaskManager
  - [ ] Добавить поля для миксинов (botControl, monitoringControl, tradingControl)
  - [ ] Реализовать функцию New() для создания API
  - [ ] Реализовать инициализацию миксинов

### 3.2. Миксин для управления ботом

- [ ] Создать файл `internal/botapi/bot_control.go`
  - [ ] Определить структуру botControl
  - [ ] Реализовать метод Start()
  - [ ] Реализовать метод Stop()
  - [ ] Реализовать метод Status()
  - [ ] Реализовать любые другие необходимые методы для управления ботом

### 3.3. Миксин для мониторинга

- [ ] Создать файл `internal/botapi/monitoring_control.go`
  - [ ] Определить структуру monitoringControl
  - [ ] Реализовать метод GetSessions()
  - [ ] Реализовать метод GetPnL()
  - [ ] Добавить рассчёт процента прибыли/убытка
  - [ ] Реализовать другие методы мониторинга, если необходимы

### 3.4. Миксин для торговли

- [ ] Создать файл `internal/botapi/trading_control.go`
  - [ ] Определить структуру tradingControl
  - [ ] Реализовать метод SellToken()
  - [ ] Реализовать метод AddTask()
  - [ ] Реализовать другие методы торговли (Swap и т.д.)

### 3.5. Модели данных

- [ ] Создать файл `internal/botapi/types.go`
  - [ ] Определить структуру PnLInfo
  - [ ] Определить структуру TokenBalance
  - [ ] Определить другие необходимые типы данных
  
### 3.6. Тесты для API

- [ ] Создать файлы тестов для каждого компонента API
  - [ ] `internal/botapi/api_test.go`
  - [ ] `internal/botapi/bot_control_test.go`
  - [ ] `internal/botapi/monitoring_control_test.go`
  - [ ] `internal/botapi/trading_control_test.go`

## Этап 4: Интерфейсы для тестирования

- [ ] Создать файл `internal/core/interfaces.go`
  - [ ] Определить интерфейс DEXProvider
  - [ ] Определить интерфейс TaskProvider
  - [ ] Определить интерфейс MonitorProvider
  - [ ] Определить другие необходимые интерфейсы

- [ ] Создать моки для тестирования
  - [ ] Создать файл `internal/core/mocks.go` или использовать testify/mock
  - [ ] Реализовать моки для каждого интерфейса

## Этап 5: Перенос UI в отдельный пакет

- [ ] Изучить существующий код в `internal/bot/ui/handler.go`

- [ ] Создать файл `internal/tui/handler.go`
  - [ ] Перенести код из существующего UI с адаптацией для использования API
  - [ ] Обновить импорты
  - [ ] Реализовать структуру Handler
  - [ ] Реализовать метод NewHandler()
  - [ ] Реализовать метод Run()
  - [ ] Адаптировать другие методы для работы через API

- [ ] Создать вспомогательные файлы для TUI, если необходимо
  - [ ] `internal/tui/views.go`
  - [ ] `internal/tui/events.go`

- [ ] Создать файл `internal/tui/handler_test.go`
  - [ ] Тесты для инициализации и базового функционирования UI

## Этап 6: Обновление main.go

- [ ] Обновить файл `cmd/bot/main.go`
  - [ ] Добавить импорты для новых пакетов
  - [ ] Обновить инициализацию логгера
  - [ ] Обновить инициализацию конфигурации
  - [ ] Обновить создание TaskManager и Runner
  - [ ] Добавить создание API
  - [ ] Заменить инициализацию UI на новый TUI пакет
  - [ ] Обновить обработку ошибок с использованием нового пакета errs

## Этап 7: Тестирование и отладка

- [ ] Написать интеграционные тесты
  - [ ] Создать файл `internal/botapi/integration_test.go`
  - [ ] Тесты для основных сценариев работы API с TUI

- [ ] Запустить приложение и проверить работу
  - [ ] Проверить запуск и остановку бота
  - [ ] Проверить выполнение задач
  - [ ] Проверить мониторинг и получение P&L
  - [ ] Проверить продажу токенов
  - [ ] Проверить обработку ошибок

- [ ] Исправить обнаруженные проблемы
  - [ ] Исправить любые интеграционные проблемы
  - [ ] Уточнить API, если необходимо
  - [ ] Улучшить обработку ошибок

## Этап 8: Документация и финализация

- [ ] Обновить комментарии в коде
  - [ ] Добавить godoc-совместимые комментарии к пакетам и экспортируемым функциям
  - [ ] Добавить примеры использования API

- [ ] Обновить README.md
  - [ ] Добавить информацию о новой структуре API
  - [ ] Добавить примеры использования

- [ ] Создать pull request
  - [ ] Убедиться, что все тесты проходят
  - [ ] Проверить покрытие кода тестами
  - [ ] Отправить PR на ревью

## Заметки по реализации

### Работа с миксинами

Миксины позволяют группировать логически связанные методы без создания излишних абстракций. При этом важно:

1. Каждый миксин должен иметь доступ к `api` через поле
2. Методы миксина должны быть чистыми прокси к методам основных структур или содержать минимальную бизнес-логику
3. Все обработки ошибок должны использовать новый пакет `errs`

### Тестирование

1. Для юнит-тестов используйте моки интерфейсов из `internal/core`
2. Для интеграционных тестов можно использовать реальные структуры с фейковыми имплементациями
3. Не забудьте протестировать граничные случаи и обработку ошибок

### Обратная совместимость

1. Не изменяйте существующие публичные методы и структуры в других пакетах
2. API должен быть расширением существующей функциональности, а не её заменой
3. Сохраняйте совместимость с существующими конфигурационными файлами